---
cip: 145
title: Multiple previous (multi-prev)
author: Aaron Goldman (@aarongoldman), Mohsin Zaidi (@smrz2001)
discussions-to: <URL to a topic under the CIP category on the Ceramic forum: https://forum.ceramic.network/c/cips>
status: Draft
category: <Core>
created: 2023-08-21
edited: 2023-08-25
---

## Simple Summary
Adding the ability to merge divergent branches of a Ceramic stream.

## Abstract
This CIP adds the ability to merge divergent branches of a stream. It describes a modification to the `prev` field for a
Ceramic event so that it can be either a single CID or a list of CIDs.

For a `prev` that is a list of CIDs, the aggregator may treat these CIDs differently depending on the order. How this
order is interpreted is an implementation detail outside the scope of this spec.

## Motivation
A Ceramic stream can fork if two different events both have the same CID in their `prev` field. This can happen for
various legitimate reasons. For example:
1. Two or more Ceramic nodes generate Data Events to the same Ceramic stream before learning of events generated from
   the other node(s).
   * A special case of this is a race between new Data Events being generated to a stream and Time Events corresponding
     to older Data Events in the stream. This type of fork in a stream is easily possible and can only be addressed at
     the protocol level.

### Definitions
* A "fork" point is the last common ancestor of two events `A` and `B`.
* A "merge" point is the first common descendent of two events `A` and `B`.
* An event A is "covered" if another event B the A's CID in its `prev` field.
* An event A is "uncovered" if there is no event with A's CID in its `prev` field.
* A "diverged" stream has more than one uncovered event.
* A "converged" stream has a single uncovered event.
* An "invalid" Data Event is one that has either a invalid signature or an expired CACAO.
* A "valid" Data Event is one that has a valid signature and a valid CACAO (if applicable).

## Specification

Branch pruning rules:
1. If a stream is in a diverged state, we only consider branches that contain valid, uncovered Data Events.
2. For branches that contain valid, uncovered Data Events, we only consider the first Data Event on a branch after the
   fork.
3. The Data Event that is covered by the earliest Time Event wins. 
4. If two uncovered Data Events are covered by Time Events at the same block height, the Data Event with the lower CID
   wins.

Any stream where there are Data Events without a common descendant are in a diverged state. When a stream diverges,
Ceramic uses the rules above to determine which of the uncovered heads will serve as the tip of the stream and which
branches are pruned. Since pruning branches that contain Data Events would result in data loss, we allow a Data Event to
contain multiple ancestor events in its `prev` field so that a single, merged Data Event can cover multiple uncovered
events.

Using multi-prev Data Events allows us to reduce the number of uncovered events and converge the stream so that there is
only a single uncovered event, without any loss of data across pruned branches. The streams converged/diverged state can
be determined by looking at the `prev` fields of all the Data Events for that stream.

TODO: Events that have an invalid signature cannot be ...

### Example
> ![lattice](../assets/cip-145/lattice.png)
> 
> Fig. 1: A lattice where 1, 2, 3 are canonical Data Events (with corresponding Time Events) and A, B are events on a
pruned branch. 2 and A both have `prev: 1's CID` thereby creating a fork. 3 has a multi-prev `prev: [2's CID, B's CID]`
thereby converging the pruned branch back into the stream.

---
Init an event is created. Tip is null

![Alt text](../assets/cip-145/ex1.png)

---
The event gets anchored and a time event is created. Tip is Init and happens at Time 1

![Alt text](../assets/cip-145/ex2.png)

---
A branches off Init not Time 1 but there are no Data events on the Time 1 branch so Data A is the tip. Data event a happens at Time 2
![Alt text](../assets/cip-145/ex3.png)

---
New Data event Data B branches off of Time 1 and happens at Time 3. The event Data B happens later then Data A so the tip is still Data A. We are now in a diverged state as Data B is on a pruned branch.
![Alt text](../assets/cip-145/ex4.png)

---
A client fixed the diverged state with Data C witch has a multi-prev covering both Time 2 and Data B. Data C is now the tip and the stream is in a converged state.
![Alt text](../assets/cip-145/ex5.png)

---

## Rationale
<!--The rationale fleshes out the specification by describing what motivated the design and why particular design decisions were made. It should describe alternate designs that were considered and related work, e.g. how the feature is supported in other languages. The rationale may also provide evidence of consensus within the community, and should discuss important objections or concerns raised during discussion.-->
Rationale goes here.


## Backwards Compatibility
Nodes that do not implement this CIP will not understand events with `prev` fields containing multiple CIDs but all
existing streams and events with single `prev` CIDs remain valid.

This branch pruning rules specified in this document supersede the behavior of the protocol described in CIPnnn even for
streams that have just a single `prev` CID.

## Implementation
<!--The implementations must be completed before any CIP is given status "Final", but it need not be completed before the CIP is accepted.-->
Implementation goes here.

legacy `prev`
```json
{ "prev": "CID1"}
```

multi-prev `prev`
```json
{ "prev": ["CID1", "CID2", "CID3"] }
```


## Security Considerations
<!--All CIPs must contain a section that discusses the security implications/considerations relevant to the proposed change. Include information that might be important for security discussions, surfaces risks and can be used throughout the life cycle of the proposal. E.g. include security-relevant design decisions, concerns, important discussions, implementation-specific guidance and pitfalls, an outline of threats and risks and how they are being addressed. CIP submissions missing the "Security Considerations" section will be rejected. An CIP cannot proceed to status "Final" without a Security Considerations discussion deemed sufficient by the reviewers.-->
Security considerations go here.


## Copyright
Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
